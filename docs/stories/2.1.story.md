# Story 2.1: Heart Reaction System

<!-- Powered by BMAD™ Core -->

## Status
Done

## Story
**As a** user,
**I want** to react to posts with a single-click heart button that provides immediate visual feedback,
**so that** I can express appreciation for content and engage with other users' posts.

## Acceptance Criteria

1. Heart icon button displayed on each post with current reaction count
2. Single-click toggles heart state with immediate visual feedback (filled/outline)
3. Reaction count updates instantly without page refresh
4. Visual animation on heart click for satisfying user interaction
5. Reaction state persists across browser sessions
6. Prevention of multiple rapid clicks through debouncing
7. Heart button meets accessibility standards with keyboard navigation
8. Reaction data integrates with existing JSON storage system

## Tasks / Subtasks

- [x] Create ReactionButton component (AC: 1, 2, 4, 7)
  - [x] Implement heart icon toggle (outline/solid) based on reaction state
  - [x] Add click animation using CSS transitions
  - [x] Implement keyboard accessibility (Space/Enter key handling)
  - [x] Add debouncing to prevent multiple rapid clicks via tRPC pending state
  - [x] Create TypeScript interfaces for reaction props
- [x] Implement tRPC reaction router and service (AC: 5, 8)
  - [x] Create `src/server/routers/reactions.ts` with toggle endpoint
  - [x] Implement `ReactionService` class in `src/server/services/reactionService.ts`
  - [x] Add reaction data operations to storage layer
  - [x] Create Zod validation schemas for reaction inputs
- [x] Integrate reaction data with Post interface (AC: 1, 3)
  - [x] Create PostCard component to include ReactionButton
  - [x] Implement optimistic updates for immediate UI feedback
  - [x] Handle error states and revert optimistic updates on failure
  - [x] Update post reaction count synchronization
- [x] Add comprehensive testing coverage
  - [x] Unit tests for ReactionButton component behavior
  - [x] Integration tests for tRPC reaction endpoints
  - [x] Test accessibility compliance (keyboard navigation)
  - [x] Test optimistic update flow and error handling

## Dev Notes

### Previous Story Insights
From Story 1.4 (JSON Data Persistence), the Post interface already includes `reactionCount: number` as a denormalized field for performance optimization. The storage system abstracts all data operations through `src/server/utils/storage.ts`, and the `data/bailanysta.json` structure includes a separate `reactions: {}` object for storing individual reaction records.

### Data Models
[Source: architecture/data-models.md]
```typescript
interface Reaction {
  id: string;                    // Unique reaction identifier
  type: 'heart';                 // Reaction type (currently only 'heart')
  postId: string;                // Target post reference
  userId: string;                // User who reacted
  createdAt: Date;               // Reaction timestamp
}

interface Post {
  // ... other fields
  reactionCount: number;         // Denormalized counter for performance
}
```

### API Specifications
[Source: architecture/backend-architecture.md]
The reaction system should implement:
- `reactions.toggle` tRPC procedure for toggling user reactions
- Business logic in `ReactionService` class with methods:
  - `toggleReaction(postId: string, userId: string): Promise<{ isLiked: boolean, reactionCount: number }>`
  - Atomic operations to prevent race conditions during concurrent reactions

### Component Specifications
[Source: architecture/components.md + frontend-architecture.md]
```typescript
interface ReactionButtonProps {
  post: Post;
  onUpdate?: (post: Post) => void;
}

// PostCard component integration - ReactionButton should be added to existing PostCard footer
// Location: src/components/feed/PostCard.tsx (already exists from Story 1.3)
// New component: src/components/feed/ReactionButton.tsx
```

### File Locations
[Source: architecture/source-tree.md]
- **ReactionButton Component**: `src/components/feed/ReactionButton.tsx`
- **tRPC Router**: `src/server/routers/reactions.ts`
- **Business Logic**: `src/server/services/reactionService.ts`
- **Storage Updates**: Enhanced `src/server/utils/storage.ts` (already exists)
- **Type Definitions**: `src/types/shared.ts` (Reaction interface to be added)
- **Test Files**: `tests/components/feed/ReactionButton.test.tsx`, `tests/server/routers/reactions.test.ts`

### Technical Implementation Requirements
[Source: architecture/coding-standards.md]
- **Type Safety**: Use tRPC client through `trpc.api.*` patterns, never direct fetch calls
- **State Management**: Implement optimistic updates with proper error handling and revert mechanisms
- **Data Validation**: All reaction inputs validated with Zod schemas in `src/utils/validation.ts`
- **Storage Operations**: Abstract all operations through storage layer - never access JSON files directly
- **Error Handling**: Use standard TRPCError format for API errors

### Performance Considerations
[Source: architecture/coding-standards.md]
- **Response Time Target**: <100ms for cached data, <500ms for database operations
- **Optimistic Updates**: Immediate UI feedback before server confirmation to meet user experience expectations
- **Debouncing**: Prevent multiple rapid clicks to avoid race conditions and improve UX

### Testing Standards
[Source: architecture/tech-stack.md]
- **Testing Framework**: Vitest for server-side testing, React Testing Library for components
- **Component Tests**: `tests/components/feed/ReactionButton.test.tsx`
- **Server Tests**: `tests/server/routers/reactions.test.ts` and `tests/server/services/reactionService.test.ts`
- **Accessibility Testing**: Keyboard navigation, screen reader compatibility
- **Integration Tests**: Full reaction flow from component click to storage update

### Technology Stack Requirements
[Source: architecture/tech-stack.md]
- **Icons**: Use Heroicons React (already in tech stack) for heart outline/solid icons
- **Animations**: Framer Motion or CSS transitions for click feedback
- **State Management**: Zustand for any global reaction state if needed
- **Validation**: Zod schemas for reaction input validation

## Testing

### Required Testing Approach
- **Component Tests**: ReactionButton interaction, state changes, accessibility
- **API Tests**: tRPC reaction toggle endpoint, error scenarios
- **Integration Tests**: End-to-end reaction flow from UI to storage
- **Performance Tests**: Reaction toggle response time under load

### Key Test Scenarios
1. **Reaction Toggle**: Heart state changes on click with visual feedback
2. **Optimistic Updates**: Immediate UI response before server confirmation
3. **Error Handling**: UI reverts optimistic changes on API errors
4. **Accessibility**: Keyboard navigation and screen reader support
5. **Persistence**: Reaction state maintained across browser sessions
6. **Concurrent Users**: Multiple users reacting to same post simultaneously

### Success Criteria
- All 8 acceptance criteria validated through automated tests
- Reaction toggle operations complete within performance targets
- Accessibility standards met (WCAG 2.1 AA compliance)
- Error scenarios gracefully handled with appropriate user feedback

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-31 | 1.0 | Initial story creation with heart reaction system requirements | Scrum Master (Bob) |

## Dev Agent Record

*This section is populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- All tasks completed successfully
- Comprehensive testing suite created
- Integration with existing tRPC and storage systems completed

### Completion Notes List
- ✅ ReactionButton component created with heart icon toggle, animations, accessibility, and debouncing
- ✅ tRPC reaction router and service implemented with proper error handling and Zod validation
- ✅ Reaction data integrated with Post interface with optimistic updates
- ✅ Comprehensive test coverage added for all components and API endpoints
- ✅ All acceptance criteria validated through implementation

### File List
**Created Files:**
- `src/components/feed/ReactionButton.tsx` - Heart reaction button component with optimistic updates
- `src/components/feed/PostCard.tsx` - Post display component integrating ReactionButton
- `src/components/feed/PostFeed.tsx` - Feed component for displaying multiple posts
- `src/server/services/reactionService.ts` - Business logic for reaction operations
- `src/server/routers/reactions.ts` - tRPC router for reaction endpoints
- `tests/components/feed/ReactionButton.test.tsx` - Comprehensive component tests
- `tests/components/feed/PostCard.test.tsx` - PostCard component tests
- `tests/server/services/reactionService.test.ts` - Service layer tests
- `tests/server/routers/reactions.test.ts` - API router tests

**Modified Files:**
- `src/types/shared.ts` - Added Reaction interface and related types
- `src/components/ui/icons.tsx` - Added HeartIcon and HeartIconSolid components
- `src/utils/validation.ts` - Added reaction validation schemas
- `src/server/utils/storage.ts` - Added reaction storage operations
- `src/server/routers/index.ts` - Integrated reactions router
- `src/server/routers/posts.ts` - Added list endpoint for feed
- `src/app/page.tsx` - Updated main feed page to use new components

## QA Results

*Results from QA Agent review of the completed story implementation*