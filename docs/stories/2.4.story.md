# Story 2.4: Enhanced Post Management

<!-- Powered by BMADâ„¢ Core -->

## Status
Done

## Story
**As a** user,
**I want** to edit and delete my own posts from my profile page,
**so that** I have control over my content and can fix mistakes or remove unwanted posts.

## Acceptance Criteria

1. Edit and delete buttons visible only on user's own posts in profile view
2. Edit functionality opens post in editable state with save/cancel options
3. Delete functionality shows confirmation dialog before permanent removal
4. Post modifications update immediately in both profile and main feed
5. Edit history tracked with "last modified" timestamp
6. Deleted posts removed from all views and JSON storage
7. Post management actions provide clear success/error feedback
8. Changes to posts update reaction and comment associations correctly

## Tasks / Subtasks

- [x] Enhance UserProfile component for post management (AC: 1, 2, 3)
  - [x] Add conditional edit/delete buttons only for current user's posts
  - [x] Implement inline post editing with save/cancel functionality
  - [x] Create confirmation modal for post deletion
  - [x] Handle optimistic updates for immediate UI feedback
- [x] Update tRPC posts router with edit/delete operations (AC: 2, 3, 6)
  - [x] Add posts.update procedure with authorization check
  - [x] Add posts.delete procedure with authorization check
  - [x] Update Zod validation schemas for post editing
  - [x] Implement proper error responses for unauthorized actions
- [x] Enhance PostService with update/delete methods (AC: 4, 5, 6, 8)
  - [x] Add updatePost method with ownership validation
  - [x] Add deletePost method with cascade deletion logic
  - [x] Track edit history with updatedAt timestamps
  - [x] Update reaction and comment associations on post changes
- [x] Create EditPostForm component (AC: 2, 7)
  - [x] Implement inline editing form with content validation
  - [x] Add character counter and mood selection preservation
  - [x] Handle form submission with loading and error states
  - [x] Integrate with existing post card design patterns
- [x] Update storage layer operations (AC: 6, 8)
  - [x] Add post update methods to storage abstraction
  - [x] Add cascade deletion for comments and reactions
  - [x] Update post counters and denormalized data
  - [x] Ensure data consistency across all storage operations
- [x] Add comprehensive testing coverage
  - [x] Unit tests for EditPostForm component behavior
  - [x] Integration tests for post update/delete API endpoints
  - [x] Test ownership validation and authorization
  - [x] Test cascade deletion and data consistency

## Dev Notes

### Previous Story Insights
From Story 2.3 (User Profile System), the following infrastructure is established:
- UserProfile component exists at `src/components/user/UserProfile.tsx` displaying user posts
- UserPostsList component exists at `src/components/user/UserPostsList.tsx` for post rendering
- PostService established at `src/server/services/postService.ts` with basic CRUD operations
- tRPC users router established with profile operations
- Storage layer supports getUserPosts method and user profile operations
- Authentication system in place through user identification patterns

### Data Models
[Source: architecture/data-models.md#Post]
```typescript
interface Post {
  id: string;                    // Unique post identifier (UUID)
  content: string;              // Post text content (max 280 characters)
  authorId: string;             // Reference to user who created the post
  authorName: string;           // Denormalized author name for performance
  createdAt: Date;             // Timestamp of post creation
  updatedAt: Date;             // Timestamp of last modification - CRITICAL for edit history
  mood?: 'Happy' | 'Thoughtful' | 'Excited' | 'Contemplative' | 'Energetic';
  hashtags: string[];          // Extracted hashtags from content
  reactionCount: number;       // Denormalized reaction count
  commentCount: number;        // Denormalized comment count
}
```

### API Specifications
[Source: architecture/api-specification.md + backend-architecture.md]
The post management system should implement:
- `posts.update` tRPC procedure for updating post content with authorization
- `posts.delete` tRPC procedure for deleting posts with cascade operations
- Business logic in `PostService` class with methods:
  - `updatePost(id: string, updates: Partial<Post>, authorId: string): Promise<Post>`
  - `deletePost(id: string, authorId: string): Promise<void>`
- Authorization validation: Only post author can edit/delete their posts

### Component Specifications
[Source: architecture/components.md + frontend-architecture.md]
```typescript
interface EditPostFormProps {
  post: Post;
  onSave: (updatedPost: Post) => void;
  onCancel: () => void;
  isLoading?: boolean;
}

interface PostActionsProps {
  post: Post;
  isOwner: boolean;  // Only show edit/delete if user owns the post
  onEdit: () => void;
  onDelete: () => void;
}

// Enhanced UserProfile component to include post management
// Enhanced UserPostsList to support inline editing capabilities
// New EditPostForm component for inline post editing
// Update PostCard component to include management actions when appropriate
```

### File Locations
[Source: architecture/source-tree.md]
- **Enhanced UserProfile**: `src/components/user/UserProfile.tsx` (existing, needs enhancement)
- **Enhanced UserPostsList**: `src/components/user/UserPostsList.tsx` (existing, needs management buttons)
- **EditPostForm Component**: `src/components/forms/EditPostForm.tsx` (new component)
- **Enhanced PostService**: `src/server/services/postService.ts` (existing, needs update/delete methods)
- **Enhanced Posts Router**: `src/server/routers/posts.ts` (existing, needs update/delete procedures)
- **Enhanced Storage**: `src/server/utils/storage.ts` (existing, needs cascade deletion)
- **Type Enhancements**: `src/types/shared.ts` (enhance with update/delete input types)
- **Validation Updates**: `src/utils/validation.ts` (add post update schemas)
- **Test Files**: `tests/components/forms/EditPostForm.test.tsx`, `tests/server/routers/posts-management.test.ts`

### Technical Implementation Requirements
[Source: architecture/coding-standards.md]
- **Authorization**: Use existing user identification system - only post author can edit/delete
- **Type Safety**: Use tRPC client through `trpc.api.*` patterns for all API calls
- **Data Validation**: All post updates validated with Zod schemas in `src/utils/validation.ts`
- **Storage Operations**: Abstract all operations through storage layer - never access JSON directly
- **Error Handling**: Use standard TRPCError format for unauthorized actions
- **State Updates**: Follow immutability patterns and optimistic updates for immediate UI feedback
- **Cascade Operations**: When deleting posts, remove associated comments and reactions

### Performance Considerations
[Source: architecture/coding-standards.md]
- **Response Time Target**: <100ms for cached data, <500ms for database operations
- **Optimistic Updates**: Immediate UI feedback for edit/delete actions before server confirmation
- **Batch Operations**: When deleting posts, batch cascade operations for comments/reactions
- **Data Consistency**: Ensure denormalized counters update correctly during post changes

### Technology Stack Requirements
[Source: architecture/tech-stack.md]
- **Form Handling**: React controlled components for inline post editing
- **Validation**: Zod schemas for post content validation (280 char limit, mood enum)
- **State Management**: Local component state for editing mode, tRPC for server operations
- **UI Components**: Tailwind CSS for styling, consistent with existing PostCard design
- **Confirmation**: Modal components for delete confirmation using existing UI patterns

### Testing Standards
[Source: architecture/tech-stack.md + coding-standards.md]
- **Testing Framework**: Vitest for server-side testing, React Testing Library for components
- **Component Tests**: `tests/components/forms/EditPostForm.test.tsx` for editing behavior
- **Server Tests**: `tests/server/routers/posts.test.ts` enhanced with update/delete tests
- **Authorization Tests**: Test that only post owners can edit/delete their content
- **Cascade Tests**: Verify that deleting posts properly removes comments and reactions
- **Integration Tests**: Full post management flow from editing to saving and deleting

## Testing

### Required Testing Approach
- **Component Tests**: EditPostForm editing behavior, PostActions button visibility and functionality
- **API Tests**: tRPC post update/delete endpoints, authorization validation, cascade operations
- **Integration Tests**: End-to-end post management from profile page editing to feed updates
- **Authorization Tests**: Non-owners cannot edit/delete posts, proper error responses

### Key Test Scenarios
1. **Edit Post**: User can edit their own posts, content validates, updates reflect immediately
2. **Delete Post**: User can delete with confirmation, post removes from all views and storage
3. **Authorization**: Non-owners cannot see or use edit/delete buttons on others' posts
4. **Cascade Deletion**: Deleting posts removes associated comments and reactions
5. **Edit History**: Post updates track timestamps and reflect "last modified" status
6. **Data Consistency**: Post changes update reaction/comment associations correctly
7. **Error Handling**: Network failures and validation errors handled gracefully
8. **Optimistic Updates**: Immediate UI feedback with proper rollback on failures

### Success Criteria
- All 8 acceptance criteria validated through automated tests
- Post management operations complete within performance targets (<500ms)
- Authorization properly prevents unauthorized access to edit/delete functionality
- Cascade deletion maintains data consistency across all storage operations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-31 | 1.0 | Initial story creation with enhanced post management requirements | Scrum Master (Bob) |

## Dev Agent Record

*This section is populated by the development agent during implementation*

### Agent Model Used
- Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- All tasks completed successfully without major debugging issues
- Minor dependency resolution issue with test setup resolved

### Completion Notes List
- âœ… All 8 acceptance criteria successfully implemented
- âœ… Enhanced PostService provides proper authorization and error handling
- âœ… EditPostForm component integrated with existing design patterns
- âœ… Storage layer enhanced with cascade deletion for data integrity
- âœ… tRPC router updated with type-safe update/delete procedures
- âœ… UserProfile enhanced with ownership-based post management UI
- âœ… Comprehensive test coverage added for all new functionality
- âœ… All implementation follows coding standards and architectural patterns

### File List
**New Files Created:**
- src/components/forms/EditPostForm.tsx
- src/server/services/postService.ts
- tests/components/forms/EditPostForm.test.tsx
- tests/server/services/postService.test.ts
- tests/server/routers/posts-management.test.ts
- tests/server/utils/storage-cascade.test.ts

**Modified Files:**
- src/components/user/UserPostsList.tsx
- src/components/user/UserProfile.tsx
- src/server/routers/posts.ts
- src/server/utils/storage.ts
- src/types/shared.ts
- src/utils/validation.ts
- tests/setup.ts

## QA Results

*Results from QA Agent review of the completed story implementation*