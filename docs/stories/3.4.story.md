# Story 3.4: Hashtag & Search Features

<!-- Powered by BMAD™ Core -->

## Status
Done 

## Story
**As a** user,
**I want** to use hashtags in posts and discover content through keyword search,
**so that** I can organize my content thematically and find relevant discussions.

## Acceptance Criteria

1. Hashtag detection in post content with automatic linking (#example)
2. Clickable hashtags filter feed to show related posts
3. Search input field in navigation for keyword-based post discovery
4. Search results highlight matching terms in post content
5. Hashtag suggestions appear during post creation
6. Popular hashtags displayed in sidebar or dedicated section
7. Search functionality works across post content, hashtags, and usernames
8. Search state persists in URL for shareable filtered views

## Tasks / Subtasks

- [ ] Implement hashtag extraction and parsing utilities (AC: 1)
  - [ ] Update `src/utils/hashtags.ts` with enhanced hashtag regex parsing
  - [ ] Add hashtag validation to ensure proper format (#word)
  - [ ] Extract hashtags during post creation and update existing posts
  - [ ] Add unit tests for hashtag extraction functions
- [ ] Create hashtag UI components and interactions (AC: 1, 2)
  - [ ] Update PostCard component to render clickable hashtag links
  - [ ] Create HashtagLink component with routing to hashtag pages
  - [ ] Style hashtags with blue color and hover effects per design system
  - [ ] Add hashtag navigation using Next.js router to `/hashtag/[tag]` routes
- [ ] Build hashtag filtering and routing system (AC: 2, 8)
  - [ ] Create `src/pages/hashtag/[tag].tsx` dynamic route page
  - [ ] Implement HashtagFeed component for filtered post display
  - [ ] Add tRPC `posts.getByHashtag` query with caching
  - [ ] Ensure URL state persistence for shareable hashtag feeds
- [ ] Implement search functionality and UI (AC: 3, 4, 7, 8)
  - [ ] Add SearchInput component to Navigation header
  - [ ] Create `src/pages/search/index.tsx` search results page
  - [ ] Implement SearchResults component with highlighted matches
  - [ ] Add tRPC `search.posts` endpoint for full-text search
  - [ ] Support search across content, hashtags, and usernames
  - [ ] Add URL query parameter persistence for search state
- [ ] Build hashtag suggestion system (AC: 5)
  - [ ] Create HashtagSuggestions component for post creation
  - [ ] Implement hashtag autocomplete with existing hashtags
  - [ ] Add real-time hashtag suggestions as user types
  - [ ] Style suggestions dropdown with keyboard navigation
- [ ] Create popular hashtags display (AC: 6)
  - [ ] Add PopularHashtags component for sidebar
  - [ ] Implement hashtag popularity ranking by usage count
  - [ ] Create responsive hashtag cloud or list design
  - [ ] Add tRPC endpoint for retrieving popular hashtags
- [ ] Update backend services and data models (AC: 1, 2, 7)
  - [ ] Enhance PostService with hashtag indexing capabilities
  - [ ] Create SearchService for advanced search functionality
  - [ ] Update storage layer with hashtag and search indexing
  - [ ] Add search performance optimizations and caching
- [ ] Comprehensive testing coverage
  - [ ] Add component tests for all new hashtag and search UI
  - [ ] Create API endpoint tests for search and hashtag functionality
  - [ ] Add integration tests for hashtag navigation workflows
  - [ ] Test search performance and edge cases

## Dev Notes

### Previous Story Insights
From Story 3.3 (Production Deployment Setup), the infrastructure is optimized for performance with:
- Bundle size targets (<500KB) that must be maintained with new search features
- Vercel Edge Network caching that can be leveraged for search result caching
- Performance monitoring setup that will track search functionality impact
- Production error handling that should cover search edge cases

### Technology Stack Context
[Source: architecture/tech-stack.md]
Key technologies for search and hashtag implementation:
- **Frontend Framework**: Next.js 14.0+ with file-based routing for hashtag/search pages
- **State Management**: Zustand 4.0+ for search state and hashtag caching
- **API Layer**: tRPC 10.0+ for type-safe search endpoints with input validation
- **Backend Framework**: Next.js API Routes 14.0+ for serverless search functions
- **Database**: JSON Files with migration path to Vercel KV for search indexing
- **Build Tool**: Turbopack for optimized bundling of search components

### Project Structure Context
[Source: architecture/source-tree.md]
File locations for new hashtag and search functionality:
```typescript
// Search and hashtag specific files
src/
├── pages/
│   ├── search/
│   │   └── index.tsx          # Search results page (AC: 3, 4, 8)
│   ├── hashtag/
│   │   └── [tag].tsx          # Hashtag feed page (AC: 2, 8)
├── components/
│   ├── feed/
│   │   ├── HashtagFeed.tsx    # Filtered hashtag posts
│   │   └── SearchResults.tsx   # Search results display
│   ├── search/
│   │   ├── SearchInput.tsx     # Navigation search field
│   │   └── HashtagSuggestions.tsx # Autocomplete suggestions
│   ├── hashtag/
│   │   ├── HashtagLink.tsx     # Clickable hashtag component
│   │   └── PopularHashtags.tsx # Hashtag sidebar/cloud
├── server/
│   ├── routers/
│   │   └── search.ts          # tRPC search router (new file)
│   ├── services/
│   │   └── searchService.ts   # Search business logic (new file)
├── utils/
│   └── hashtags.ts            # Enhanced hashtag extraction utilities
```

### Data Models Context
[Source: architecture/data-models.md]
Hashtag integration with existing Post model:
```typescript
// Post model already includes hashtags field
interface Post {
  id: string;
  content: string;
  authorId: string;
  authorName: string;
  createdAt: Date;
  updatedAt: Date;
  mood?: 'Happy' | 'Thoughtful' | 'Excited' | 'Contemplative' | 'Energetic';
  hashtags: string[];           // Already exists - populated during post creation
  reactionCount: number;
  commentCount: number;
}

// Search functionality will query across these fields:
// - Post.content (full-text search)
// - Post.hashtags (hashtag matching)  
// - Post.authorName (username search)
```

### API Specifications Context
[Source: architecture/api-specification.md]
Required tRPC endpoints for hashtag and search features:
```typescript
// New search router to be added
search: router({
  posts: publicProcedure
    .input(z.object({ 
      query: z.string().min(1).max(100),
      limit: z.number().min(1).max(50).default(20),
    }))
    .query(async ({ input }) => {
      return await searchService.searchPosts(input.query, input.limit);
    }),
    
  popularHashtags: publicProcedure
    .input(z.object({ limit: z.number().min(1).max(20).default(10) }))
    .query(async ({ input }) => {
      return await searchService.getPopularHashtags(input.limit);
    }),
}),

// Existing posts router already has:
posts: router({
  getByHashtag: publicProcedure
    .input(z.object({ hashtag: z.string() }))
    .query(async ({ input }) => {
      return await postService.getPostsByHashtag(input.hashtag);
    }),
}),
```

### Frontend Architecture Context
[Source: architecture/frontend-architecture.md + components.md]
Component implementation patterns to follow:
```typescript
// Search component with tRPC integration
const SearchResults: React.FC<SearchResultsProps> = ({ query }) => {
  const { data: posts, isLoading } = trpc.search.posts.useQuery({ query });
  
  // Highlight matching terms in search results (AC: 4)
  const highlightMatches = (text: string, query: string) => {
    // Implementation for text highlighting
  };
  
  return (
    <div className="search-results">
      {posts?.map(post => (
        <PostCard 
          key={post.id} 
          post={post}
          highlightQuery={query} // For AC: 4 highlighting
        />
      ))}
    </div>
  );
};

// Hashtag link component with Next.js routing
const HashtagLink: React.FC<{ hashtag: string }> = ({ hashtag }) => {
  const router = useRouter();
  
  const handleClick = () => {
    router.push(`/hashtag/${encodeURIComponent(hashtag)}`);
  };
  
  return (
    <button
      onClick={handleClick}
      className="text-blue-600 dark:text-blue-400 hover:underline text-sm"
    >
      #{hashtag}
    </button>
  );
};
```

### Backend Architecture Context  
[Source: architecture/backend-architecture.md]
Search service implementation following existing patterns:
```typescript
// SearchService following PostService patterns
export class SearchService {
  async searchPosts(query: string, limit: number = 20): Promise<Post[]> {
    const data = await storage.loadData();
    const posts = Object.values(data.posts);
    
    // Search across content, hashtags, and usernames
    const searchResults = posts.filter(post => {
      const contentMatch = post.content.toLowerCase().includes(query.toLowerCase());
      const hashtagMatch = post.hashtags.some(tag => 
        tag.toLowerCase().includes(query.toLowerCase())
      );
      const authorMatch = post.authorName.toLowerCase().includes(query.toLowerCase());
      
      return contentMatch || hashtagMatch || authorMatch;
    });
    
    // Sort by relevance and date
    return searchResults
      .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
      .slice(0, limit);
  }
  
  async getPopularHashtags(limit: number = 10): Promise<{ hashtag: string; count: number }[]> {
    const data = await storage.loadData();
    const posts = Object.values(data.posts);
    
    // Count hashtag usage across all posts
    const hashtagCounts: Record<string, number> = {};
    posts.forEach(post => {
      post.hashtags.forEach(hashtag => {
        hashtagCounts[hashtag] = (hashtagCounts[hashtag] || 0) + 1;
      });
    });
    
    // Return top hashtags by usage count
    return Object.entries(hashtagCounts)
      .map(([hashtag, count]) => ({ hashtag, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, limit);
  }
}
```

### Hashtag Utilities Context
[Source: architecture/source-tree.md + coding-standards.md]
Enhanced hashtag extraction utilities:
```typescript
// src/utils/hashtags.ts - Enhanced implementation
export const extractHashtags = (content: string): string[] => {
  // Regex for hashtag extraction: word boundaries, alphanumeric + underscore
  const hashtagRegex = /#([a-zA-Z0-9_]+)(?=\s|$|[^\w])/g;
  const matches = content.match(hashtagRegex);
  
  if (!matches) return [];
  
  // Remove # symbol and deduplicate
  const hashtags = matches
    .map(tag => tag.slice(1).toLowerCase())
    .filter((tag, index, arr) => arr.indexOf(tag) === index)
    .filter(tag => tag.length > 0 && tag.length <= 50); // Validation
    
  return hashtags;
};

export const formatHashtagsInContent = (content: string): JSX.Element => {
  // Split content and replace hashtags with clickable components
  const parts = content.split(/(#[a-zA-Z0-9_]+)/g);
  
  return (
    <>
      {parts.map((part, index) => {
        if (part.startsWith('#')) {
          const hashtag = part.slice(1);
          return <HashtagLink key={index} hashtag={hashtag} />;
        }
        return part;
      })}
    </>
  );
};
```

### Search Performance and Caching Context
[Source: architecture/coding-standards.md]
Performance optimization requirements:
```typescript
// Performance targets for search functionality
interface SearchPerformance {
  responseTime: '<500ms for search queries';
  caching: {
    searchResults: 'SWR pattern with 30-second stale time';
    popularHashtags: 'Cache for 5 minutes, background refresh';
    hashtagFeeds: 'Standard post caching strategy';
  };
  indexing: {
    strategy: 'In-memory indexing for JSON storage';
    future: 'Vercel KV for Redis-based search indexing';
  };
}

// Search result caching with tRPC
const { data: searchResults } = trpc.search.posts.useQuery(
  { query }, 
  { 
    staleTime: 30 * 1000, // 30 seconds
    cacheTime: 5 * 60 * 1000, // 5 minutes
    enabled: query.length > 0,
  }
);
```

### Navigation Integration Context
[Source: architecture/frontend-architecture.md]
Navigation component updates for search integration:
```typescript
// Navigation.tsx updates to include SearchInput
const Navigation: React.FC = () => {
  const router = useRouter();
  const [searchQuery, setSearchQuery] = useState('');
  
  const handleSearch = (query: string) => {
    if (query.trim()) {
      router.push(`/search?q=${encodeURIComponent(query.trim())}`);
    }
  };
  
  return (
    <nav className="navigation">
      {/* Existing navigation elements */}
      <div className="flex-1 max-w-lg mx-4">
        <SearchInput 
          onSearch={handleSearch}
          placeholder="Search posts, hashtags, users..."
          className="w-full"
        />
      </div>
      {/* Rest of navigation */}
    </nav>
  );
};
```

## Testing

### Required Testing Approach
- **Component Testing**: Comprehensive tests for all new hashtag and search UI components
- **API Testing**: tRPC endpoint testing for search functionality and hashtag filtering
- **Integration Testing**: End-to-end workflows for hashtag navigation and search user journeys
- **Performance Testing**: Search response times and bundle size impact verification
- **Accessibility Testing**: Keyboard navigation and screen reader compatibility for search features
- **Edge Case Testing**: Empty search results, special characters in hashtags, malformed queries

### Key Test Scenarios
1. **Hashtag Extraction**: Verify hashtag parsing from post content with various formats
2. **Hashtag Navigation**: Click hashtag links to navigate to filtered feeds
3. **Search Functionality**: Keyword search across posts, hashtags, and usernames
4. **Search Highlighting**: Matching terms highlighted in search results
5. **Hashtag Suggestions**: Autocomplete functionality during post creation
6. **Popular Hashtags**: Display and navigation of trending hashtags
7. **URL Persistence**: Search and hashtag states maintained in browser URL
8. **Performance**: Search response times under performance budgets

### Success Criteria
- All 8 acceptance criteria validated through automated and manual testing
- Hashtag extraction correctly identifies and links hashtags in post content
- Search functionality returns relevant results with proper highlighting
- Navigation between hashtag feeds and search results works seamlessly
- Hashtag suggestions appear and function correctly during post creation
- Popular hashtags display accurately reflects usage patterns
- URL state persistence enables shareable search and hashtag links
- Performance impact stays within established bundle size and response time targets

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-01 | 1.0 | Initial story creation for Hashtag & Search Features | Scrum Master (Bob) |

## Dev Agent Record

*This section is populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Expert Senior Software Engineer & Implementation Specialist

### Debug Log References
*References to debug logs will be added during implementation*

### Completion Notes List
*Task completion notes will be added as development progresses*

### File List
*List of created/modified files will be populated during implementation*

## QA Results

*Results from QA Agent review of the completed story implementation*