# Story 2.3: User Profile System

<!-- Powered by BMADâ„¢ Core -->

## Status
Ready for Review

## Story
**As a** user,
**I want** to view and manage my personal profile with my posted content,
**so that** I can see my contribution to the platform and manage my posts.

## Acceptance Criteria

1. Profile page accessible via main navigation showing user's posts only
2. User can set and edit display name for their posts
3. Profile shows total post count and join date
4. User's posts displayed in reverse chronological order on profile
5. Basic profile editing interface for name and bio (optional field)
6. Profile data persists in JSON storage with user identifier
7. Navigation between main feed and profile maintains app state
8. Profile page responsive across desktop and mobile viewports

## Tasks / Subtasks

- [ ] Create UserProfile component (AC: 1, 3, 4, 8)
  - [ ] Implement profile header with user info display
  - [ ] Add post count and join date display
  - [ ] Create user posts list with reverse chronological ordering
  - [ ] Ensure responsive design for desktop and mobile
- [ ] Implement tRPC user router and service (AC: 2, 5, 6)
  - [ ] Create `src/server/routers/users.ts` with profile endpoints
  - [ ] Implement `UserService` class in `src/server/services/userService.ts`
  - [ ] Add user profile operations to storage layer
  - [ ] Create Zod validation schemas for user profile inputs
- [ ] Create EditProfileForm component (AC: 2, 5)
  - [ ] Implement form for editing display name and bio
  - [ ] Add form validation and submission handling
  - [ ] Integrate with user update endpoints
  - [ ] Handle form state and optimistic updates
- [ ] Add profile navigation and routing (AC: 1, 7)
  - [ ] Update Navigation component with profile link
  - [ ] Create profile page at `/profile/index.tsx`
  - [ ] Implement state preservation during navigation
  - [ ] Add profile access from user posts/comments
- [ ] Add comprehensive testing coverage
  - [ ] Unit tests for UserProfile component behavior
  - [ ] Integration tests for tRPC user endpoints
  - [ ] Test profile editing and data persistence
  - [ ] Test responsive layout and navigation

## Dev Notes

### Previous Story Insights
From Story 2.2 (Comment System), the following infrastructure is established:
- Storage system abstracts operations through `src/server/utils/storage.ts`
- Data structure uses `data/bailanysta.json` with separate objects for different data types
- tRPC integration established with proper error handling and Zod validation
- PostCard component exists at `src/components/feed/PostCard.tsx` ready for extension
- Optimistic updates pattern implemented for immediate UI feedback
- User identification system in place through `authorId` and `authorName` fields

### Data Models
[Source: architecture/data-models.md#User]
```typescript
interface User {
  id: string;                    // Unique user identifier (UUID)
  username: string;              // Display name for posts and interactions
  email?: string;                // Optional email for future authentication
  bio?: string;                  // Optional profile description
  joinedAt: Date;               // Account creation timestamp
  postCount: number;            // Denormalized post count
  preferences: UserPreferences; // Theme and display preferences
}

interface UserPreferences {
  theme: 'light' | 'dark' | 'system';
  language: 'en' | 'ru';
}
```

### API Specifications
[Source: architecture/backend-architecture.md + components.md]
The user profile system should implement:
- `users.getProfile` tRPC procedure for retrieving user profile data
- `users.updateProfile` tRPC procedure for updating profile information
- `users.getUserPosts` tRPC procedure for retrieving user's posts
- Business logic in `UserService` class with methods:
  - `getUserProfile(id: string): Promise<UserProfile>`
  - `updateUser(id: string, data: UpdateUserInput): Promise<User>`
  - `getUserPosts(userId: string, pagination: PaginationParams): Promise<Post[]>`

### Component Specifications
[Source: architecture/components.md + frontend-architecture.md]
```typescript
interface UserProfileProps {
  userId?: string;  // If not provided, shows current user's profile
}

interface EditProfileFormProps {
  user: User;
  onSubmit: (updatedUser: User) => void;
  onCancel: () => void;
}

interface UserPostsListProps {
  userId: string;
  posts: Post[];
  isLoading?: boolean;
}

// Navigation component integration - add profile link
// Location: src/components/layout/Navigation.tsx (already exists)
// New component: src/components/user/UserProfile.tsx
// New component: src/components/forms/EditProfileForm.tsx
// New component: src/components/user/UserPostsList.tsx
```

### File Locations
[Source: architecture/source-tree.md]
- **UserProfile Component**: `src/components/user/UserProfile.tsx`
- **EditProfileForm Component**: `src/components/forms/EditProfileForm.tsx`
- **UserPostsList Component**: `src/components/user/UserPostsList.tsx`
- **Profile Page**: `src/pages/profile/index.tsx`
- **tRPC Router**: `src/server/routers/users.ts`
- **Business Logic**: `src/server/services/userService.ts`
- **Storage Updates**: Enhanced `src/server/utils/storage.ts` (already exists)
- **Type Definitions**: `src/types/shared.ts` (User interface to be enhanced)
- **Test Files**: `tests/components/user/UserProfile.test.tsx`, `tests/server/routers/users.test.ts`

### Technical Implementation Requirements
[Source: architecture/coding-standards.md]
- **Type Safety**: Use tRPC client through `trpc.api.*` patterns, never direct fetch calls
- **Data Validation**: All profile inputs validated with Zod schemas in `src/utils/validation.ts`
- **Storage Operations**: Abstract all operations through storage layer - never access JSON files directly
- **Error Handling**: Use standard TRPCError format for API errors
- **State Updates**: Follow immutability patterns for profile state management
- **Authentication**: Use existing user identification system from posts/comments

### Performance Considerations
[Source: architecture/coding-standards.md]
- **Response Time Target**: <100ms for cached data, <500ms for database operations
- **Profile Loading**: Load profile data efficiently, implement caching for frequently accessed profiles
- **Posts Loading**: Paginated loading for user posts to avoid large data transfers
- **Post Count Updates**: Denormalized counter updates for immediate UI feedback

### Testing Standards
[Source: architecture/tech-stack.md + coding-standards.md]
- **Testing Framework**: Vitest for server-side testing, React Testing Library for components
- **Component Tests**: `tests/components/user/UserProfile.test.tsx`, `tests/components/forms/EditProfileForm.test.tsx`
- **Server Tests**: `tests/server/routers/users.test.ts` and `tests/server/services/userService.test.ts`
- **Profile Form Tests**: Name/bio validation, character limits, form submission
- **Integration Tests**: Full profile flow from viewing to editing and saving

### Technology Stack Requirements
[Source: architecture/tech-stack.md]
- **Form Handling**: React controlled components for profile editing
- **Validation**: Zod schemas for profile input validation
- **State Management**: Local component state for editing, tRPC for data fetching
- **UI Components**: Tailwind CSS for styling, consistent with existing component design
- **Navigation**: Next.js routing for profile page, maintain app state during navigation

## Testing

### Required Testing Approach
- **Component Tests**: UserProfile display, EditProfileForm handling, UserPostsList rendering
- **API Tests**: tRPC user profile endpoints, error scenarios, data persistence
- **Integration Tests**: End-to-end profile flow from navigation to editing and saving
- **Navigation Tests**: Profile access, state preservation, responsive behavior

### Key Test Scenarios
1. **Profile Display**: Profile page shows correct user info, post count, join date
2. **Profile Editing**: Form allows name/bio editing, validates inputs, saves correctly
3. **Posts Display**: User posts appear in reverse chronological order on profile
4. **Navigation**: Profile accessible from main nav, maintains state during transitions
5. **Responsive Design**: Profile layout works correctly on desktop and mobile
6. **Data Persistence**: Profile updates persist in JSON storage and reflect immediately
7. **Error Handling**: Invalid inputs and API errors handled gracefully
8. **Authentication**: Profile editing restricted to profile owner

### Success Criteria
- All 8 acceptance criteria validated through automated tests
- Profile operations complete within performance targets (<500ms)
- Profile data persistence verified across browser sessions
- Responsive design confirmed on mobile and desktop viewports

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-31 | 1.0 | Initial story creation with user profile system requirements | Scrum Master (Bob) |

## Dev Agent Record

*This section is populated by the development agent during implementation*

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- No debug issues encountered during implementation

### Completion Notes List
- Successfully implemented complete user profile system according to all acceptance criteria
- Created comprehensive UserProfile component with responsive design
- Implemented EditProfileForm with validation and character counting
- Added UserPostsList component for displaying user's posts in reverse chronological order
- Created UserService for business logic and tRPC users router for API endpoints
- Enhanced User interface with bio, preferences, and postCount fields
- Added proper navigation and routing for profile pages
- Implemented comprehensive test coverage for all components and services
- All components follow existing design patterns and coding standards
- Profile system integrates seamlessly with existing post and comment system

### File List
**Created Files:**
- `src/components/user/UserProfile.tsx` - Main profile display component
- `src/components/user/UserPostsList.tsx` - User posts list component
- `src/components/forms/EditProfileForm.tsx` - Profile editing form
- `src/components/ui/Input.tsx` - Reusable input component
- `src/pages/profile/index.tsx` - Profile page for current user
- `src/pages/profile/[userId].tsx` - Dynamic profile page for any user
- `src/server/services/userService.ts` - User business logic service
- `src/server/routers/users.ts` - tRPC user API router
- `tests/components/user/UserProfile.test.tsx` - UserProfile component tests
- `tests/components/forms/EditProfileForm.test.tsx` - EditProfileForm tests
- `tests/server/services/userService.test.ts` - UserService tests
- `tests/server/routers/users.test.ts` - Users router tests

**Modified Files:**
- `src/types/shared.ts` - Enhanced User interface and added profile-related types
- `src/utils/validation.ts` - Added user profile validation schemas and helpers
- `src/server/utils/storage.ts` - Added getUserPosts method and enhanced user operations
- `src/server/routers/index.ts` - Added users router to main router
- `src/components/ui/icons.tsx` - Added EditIcon and CalendarIcon
- `src/components/ui/index.ts` - Added Input component export

## QA Results

*Results from QA Agent review of the completed story implementation*