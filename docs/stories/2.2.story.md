# Story 2.2: Comment System

<!-- Powered by BMADâ„¢ Core -->

## Status
Done

## Story
**As a** user,
**I want** to add text comments to posts and view existing comments inline,
**so that** I can engage in conversations and discussions about shared content.

## Acceptance Criteria

1. Comment input field appears below each post with "Add comment" placeholder
2. Submit button or Enter key publishes comment immediately
3. Comments display in chronological order under their parent post
4. Each comment shows author name and timestamp
5. Comment character limit of 140 characters with counter
6. Comments persist in JSON storage linked to parent post
7. Empty state message for posts without comments
8. Comment input clears after successful submission

## Tasks / Subtasks

- [x] Create CommentSection component (AC: 1, 2, 5, 7, 8)
  - [x] Implement comment input field with placeholder and character counter
  - [x] Add submit button and Enter key handling for comment submission
  - [x] Create empty state display for posts without comments
  - [x] Clear input field after successful comment submission
  - [x] Add input validation and character limit enforcement
- [x] Implement tRPC comment router and service (AC: 6)
  - [x] Create `src/server/routers/comments.ts` with create and list endpoints
  - [x] Implement `CommentService` class in `src/server/services/commentService.ts`
  - [x] Add comment data operations to storage layer
  - [x] Create Zod validation schemas for comment inputs
- [x] Integrate comments display with PostCard (AC: 3, 4)
  - [x] Display comments in chronological order under parent post
  - [x] Show comment author name and timestamp for each comment
  - [x] Update PostCard to include CommentSection component
  - [x] Handle comment count updates and synchronization
- [x] Add comprehensive testing coverage
  - [x] Unit tests for CommentSection component behavior
  - [x] Integration tests for tRPC comment endpoints
  - [x] Test comment character limit and validation
  - [x] Test comment persistence and retrieval

## Dev Notes

### Previous Story Insights
From Story 2.1 (Heart Reaction System), the following infrastructure is established:
- Storage system abstracts operations through `src/server/utils/storage.ts`
- Data structure uses `data/bailanysta.json` with separate objects for different data types
- tRPC integration established with proper error handling and Zod validation
- PostCard component exists at `src/components/feed/PostCard.tsx` ready for extension
- Optimistic updates pattern implemented for immediate UI feedback

### Data Models
[Source: architecture/data-models.md#Comment]
```typescript
interface Comment {
  id: string;                    // Unique comment identifier
  content: string;               // Comment text (max 140 characters)
  postId: string;                // Reference to parent post
  authorId: string;              // Comment author reference
  authorName: string;            // Denormalized author name
  createdAt: Date;               // Comment timestamp
}

interface Post {
  // ... other fields
  commentCount: number;          // Denormalized comment count for performance
}
```

### API Specifications
[Source: architecture/backend-architecture.md]
The comment system should implement:
- `comments.create` tRPC procedure for creating new comments
- `comments.listByPost` tRPC procedure for retrieving post comments
- Business logic in `CommentService` class with methods:
  - `createComment(data: CreateCommentInput): Promise<Comment>`
  - `getCommentsByPostId(postId: string): Promise<Comment[]>`
- Atomic operations to update both comment records and post.commentCount

### Component Specifications
[Source: architecture/components.md + frontend-architecture.md]
```typescript
interface CommentSectionProps {
  post: Post;
  onCommentAdded?: (comment: Comment) => void;
}

interface CommentInputProps {
  postId: string;
  onCommentSubmit: (comment: Comment) => void;
}

interface CommentListProps {
  postId: string;
  comments: Comment[];
}

// PostCard component integration - CommentSection should be added to PostCard footer
// Location: src/components/feed/PostCard.tsx (already exists from Story 1.3)
// New component: src/components/feed/CommentSection.tsx
```

### File Locations
[Source: architecture/source-tree.md]
- **CommentSection Component**: `src/components/feed/CommentSection.tsx`
- **tRPC Router**: `src/server/routers/comments.ts`
- **Business Logic**: `src/server/services/commentService.ts`
- **Storage Updates**: Enhanced `src/server/utils/storage.ts` (already exists)
- **Type Definitions**: `src/types/shared.ts` (Comment interface to be added)
- **Test Files**: `tests/components/feed/CommentSection.test.tsx`, `tests/server/routers/comments.test.ts`

### Technical Implementation Requirements
[Source: architecture/coding-standards.md]
- **Type Safety**: Use tRPC client through `trpc.api.*` patterns, never direct fetch calls
- **Data Validation**: All comment inputs validated with Zod schemas in `src/utils/validation.ts`
- **Storage Operations**: Abstract all operations through storage layer - never access JSON files directly
- **Error Handling**: Use standard TRPCError format for API errors
- **State Updates**: Follow immutability patterns for comment state management

### Performance Considerations
[Source: architecture/coding-standards.md]
- **Response Time Target**: <100ms for cached data, <500ms for database operations
- **Character Limit**: 140 characters enforced client-side and server-side for optimal UX
- **Comment Loading**: Load comments for visible posts only, implement lazy loading if needed
- **Comment Count Updates**: Denormalized counter updates for immediate UI feedback

### Testing Standards
[Source: architecture/tech-stack.md]
- **Testing Framework**: Vitest for server-side testing, React Testing Library for components
- **Component Tests**: `tests/components/feed/CommentSection.test.tsx`
- **Server Tests**: `tests/server/routers/comments.test.ts` and `tests/server/services/commentService.test.ts`
- **Input Validation Tests**: Character limit enforcement, empty comment prevention
- **Integration Tests**: Full comment flow from input to storage and display

### Technology Stack Requirements
[Source: architecture/tech-stack.md]
- **Form Handling**: React controlled components for comment input
- **Validation**: Zod schemas for comment input validation
- **State Management**: Local component state for comment input, tRPC for data fetching
- **UI Components**: Tailwind CSS for styling, consistent with existing PostCard design
- **Timestamp Formatting**: Use Intl.RelativeTimeFormat for consistent time display

## Testing

### Required Testing Approach
- **Component Tests**: CommentSection input handling, comment display, character counter
- **API Tests**: tRPC comment create and list endpoints, error scenarios
- **Integration Tests**: End-to-end comment flow from input to storage and display
- **Validation Tests**: Character limit enforcement, comment content validation

### Key Test Scenarios
1. **Comment Creation**: Input field accepts valid comments and submits correctly
2. **Character Limit**: Counter displays correctly and prevents submission over 140 chars
3. **Comment Display**: Comments appear in chronological order with correct author/timestamp
4. **Empty States**: Appropriate message shown for posts without comments
5. **Input Clearing**: Comment input field clears after successful submission
6. **Error Handling**: Invalid inputs and API errors handled gracefully
7. **Comment Count**: Post comment count updates correctly after adding comments

### Success Criteria
- All 8 acceptance criteria validated through automated tests
- Comment operations complete within performance targets (<500ms)
- Character limit enforced consistently client and server side
- Comment persistence verified across browser sessions

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-31 | 1.0 | Initial story creation with comment system requirements | Scrum Master (Bob) |

## Dev Agent Record

*This section is populated by the development agent during implementation*

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
None required - implementation proceeded without blocking issues.

### Completion Notes List
- All 8 acceptance criteria successfully implemented
- Comment system integrated with existing PostCard and tRPC infrastructure
- Character limit (140) enforced both client and server side
- Comments display chronologically with proper author attribution
- Empty state handling implemented for posts without comments
- Input field clears after successful submission
- Post comment count updates atomically with comment creation/deletion
- Full error handling and validation in place

### File List

**Created Files:**
- `src/components/feed/CommentSection.tsx` - Main comment UI component
- `src/server/services/commentService.ts` - Business logic for comment operations
- `src/server/routers/comments.ts` - tRPC router for comment endpoints
- `tests/components/feed/CommentSection.test.tsx` - Component unit tests
- `tests/server/services/commentService.test.ts` - Service layer tests
- `tests/server/routers/comments.test.ts` - Router endpoint tests
- `tests/integration/comment-flow.test.tsx` - End-to-end integration tests

**Modified Files:**
- `src/types/shared.ts` - Added Comment interface and related types
- `src/utils/validation.ts` - Added comment validation schemas and utilities
- `src/server/utils/storage.ts` - Added comment CRUD operations and updated interfaces
- `src/server/routers/index.ts` - Registered comments router
- `src/components/feed/PostCard.tsx` - Integrated CommentSection with toggle functionality
- `tests/server/utils/storage.test.ts` - Added comprehensive comment storage tests

## QA Results

*Results from QA Agent review of the completed story implementation*